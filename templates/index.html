<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFID Player Registry</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; transition: background-color 0.3s; }
        .table th { background-color: #000 !important; color: white !important; }
        .rfid-cell { font-family: monospace; font-size: 0.9rem; }
        .dark body { background-color: #121212; color: #ddd; }
        .dark .table { --bs-table-bg: #1e1e1e; --bs-table-color: #ddd; }
        .dark .table-striped tbody tr:nth-of-type(odd) { background-color: #252525; }
        .dark .alert, .dark .modal-content { background-color: #1e1e1e; color: #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="mb-0">RFID Player Registry</h1>
            <div class="d-flex gap-2 align-items-center">
                <span id="status" class="badge bg-success">Connected to FX7500 ‚Ä¢ Live</span>
                <button id="darkToggle" class="btn btn-outline-secondary btn-sm" onclick="toggleDarkMode()">üåô Dark Mode</button>
            </div>
        </div>

        <div class="d-flex gap-2 mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="Search by name or RFID..." onkeyup="filterTable()" style="max-width: 320px;">
            <button class="btn btn-outline-secondary" onclick="clearSearch()">Clear</button>
            <button class="btn btn-success" onclick="exportCSV()">üì• Export CSV</button>
        </div>

        <table class="table table-striped table-hover" id="profiles-table">
            <thead class="table-dark">
                <tr>
                    <th>Profile ID</th>
                    <th>Player Name</th>
                    <th>Driver #</th>
                    <th>RFID ID (EPC)</th>
                    <th style="width: 160px;">Actions</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>

        <div class="text-muted small mt-3">
            New unique RFID tags are added instantly with beep sound ‚Ä¢ List updates every 2 seconds
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Profile #<span id="modal-profile-id"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-form">
                        <input type="hidden" id="edit-profile-id">
                        <div class="mb-3">
                            <label class="form-label">RFID ID (read-only)</label>
                            <input type="text" class="form-control" id="edit-rfid" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Player Name</label>
                            <input type="text" class="form-control" id="edit-player" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Driver Number (0-100)</label>
                            <input type="number" class="form-control" id="edit-driver" min="0" max="100" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let modalInstance = null;
        let previousLength = 0;

        function playBeep() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            osc.type = 'sine';
            osc.frequency.value = 900;
            const gain = ctx.createGain();
            gain.gain.value = 0.25;
            osc.connect(gain).connect(ctx.destination);
            osc.start();
            setTimeout(() => osc.stop(), 180);
        }

        function populateTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">No profiles yet.<br><small>Scan RFID tags to begin</small></td></tr>`;
                previousLength = 0;
                return;
            }

            data.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${entry.profile_id}</strong></td>
                    <td>${entry.player_name}</td>
                    <td>${entry.driver_number}</td>
                    <td class="rfid-cell">${entry.rfid_id}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openEditModal(${entry.profile_id}, '${entry.rfid_id}', '${entry.player_name}', ${entry.driver_number})">Edit</button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteProfile(${entry.profile_id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Beep on new entries
            if (data.length > previousLength) playBeep();
            previousLength = data.length;
        }

        function refreshData() {
            fetch('/data')
                .then(r => r.json())
                .then(data => {
                    populateTable(data);
                    document.getElementById('status').className = 'badge bg-success';
                    document.getElementById('status').textContent = 'Connected to FX7500 ‚Ä¢ Live';
                })
                .catch(() => {
                    document.getElementById('status').className = 'badge bg-danger';
                    document.getElementById('status').textContent = 'Reader offline';
                });
        }

        function filterTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('#table-body tr').forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
            });
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterTable();
        }

        function exportCSV() {
            window.location.href = '/export';
        }

        function openEditModal(profileId, rfidId, playerName, driverNum) {
            document.getElementById('edit-profile-id').value = profileId;
            document.getElementById('modal-profile-id').textContent = profileId;
            document.getElementById('edit-rfid').value = rfidId;
            document.getElementById('edit-player').value = playerName;
            document.getElementById('edit-driver').value = driverNum;
            if (!modalInstance) modalInstance = new bootstrap.Modal('#editModal');
            modalInstance.show();
        }

        function saveEdit() {
            const profile_id = document.getElementById('edit-profile-id').value;
            const player_name = document.getElementById('edit-player').value;
            const driver_number = document.getElementById('edit-driver').value;

            fetch('/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ profile_id, player_name, driver_number })
            }).then(() => {
                modalInstance.hide();
                refreshData();
            });
        }

        function deleteProfile(id) {
            if (!confirm(`Delete Profile #${id} permanently?`)) return;
            fetch('/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ profile_id: id })
            }).then(() => refreshData());
        }

        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark');
            document.getElementById('darkToggle').textContent = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
            localStorage.setItem('darkMode', isDark);
        }

        window.onload = () => {
            // Restore dark mode
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark');
                document.getElementById('darkToggle').textContent = '‚òÄÔ∏è Light Mode';
            }
            refreshData();
            setInterval(refreshData, 2000);
        };
    </script>
</body>
</html>
